name: Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    # Adapted from https://github.com/ProjectAliceDev/renpy-build-action
    runs-on: ubuntu-22.04

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
      
      - name: Download and extract Renpy
        working-directory: ..
        run: |
          wget https://www.renpy.org/dl/8.2.0/renpy-8.2.0-sdk.tar.bz2
          tar -xf renpy-8.2.0-sdk.tar.bz2
          rm renpy-8.2.0-sdk.tar.bz2

      # - name: Build the game
      #   working-directory: ../renpy-8.2.0-sdk
      #   run: |
      #     ./renpy.sh launcher distribute $GITHUB_WORKSPACE --package pc --package mac --package linux

      # - name: Release binaries
      #   uses: svenstaro/upload-release-action@2.7.0
      #   with:
      #     file: ../CarbonWashing-1.0-dists/*
      #     tag: automatic
      #     overwrite: true
      #     file_glob: true
      #     prerelease: true
      #     body: Automatic release of our game. MAY NOT BE WORKING PROPERLY.

      - name: Build the web-version of the game
        working-directory: ../renpy-8.2.0-sdk
        run: |
          ./renpy.sh launcher distribute $GITHUB_WORKSPACE --package web
          pwd
          ls /home/runner/work/CarbonWashing/CarbonWashing-1.0-dists

      - name: Deploy web version to server
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
            server: ${{ secrets.HOST }}
            username: ${{ secrets.USERNAME }}
            password: ${{ secrets.PASSWORD }}
            port: ${{ secrets.PORT }}
            local_path: /home/runner/work/CarbonWashing/CarbonWashing-1.0-dists/CarbonWashing-1.0-web.zip
            remote_path: ${{ secrets.BASEDIR }}
            sftp_only: true

      - name: Restart the web version
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            cd ${{ secrets.BASEDIR }}
            echo test > test.txt
